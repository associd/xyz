<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="X-UA-Compatible" content="ie=edge">
   <title>GetImageData</title>
   <script src="partical.js"></script>
   <script src="../Utils.js"></script>
   <script>
      utilsInit()

      //挂载到window上的action 要小心!
      window.action = {}
      window.onload = function() {
         events()
         show(setCanvas(createCanvas(), "#upside-box"))
      }

      //要显示的东西 在这个函数里使用
      function show(canvas) {
         //注册事件
         var particals = new ParticalSystem
         window.action.addEvent("get", function(event, type) {
            if(type == "input" || type == "change") {
               var userInput = event.target.value
               var length =userInput.length
               var ctx = getContext(canvas)
               var color = "rgba(123,255,33,1)"

               clearCtx(canvas, 0, 0, canvas.width, canvas.height)
               setFont(canvas, "60px Consolas")
               ctx.textBaseline = "bottom"
               ctx.fillStyle = color
               drawText(canvas, userInput, 100, 100)

               length *= 60
               if(length > canvas.width - 200) {
                  length = canvas.width - 200
               }

               if(length > 0) {
                  var imageData = ctx.getImageData(100, 20, length, 80)
                  var data = imageData.data
                  var width = imageData.width
                  var height = imageData.height

                  var x = 0
                  var y = 0
                  var i = 0
                  for(; y < width; y++) {
                     for(; x < height; x++) {
                        i = y*width+x
                        if(data[i*4+0] == 123
                           && data[i*4+1] == 255
                           && data[i*4+2] == 33
                           && data[i*4+3] == 1){

                        }
                     }
                  }
               }
            }
         })
      }
      function createCanvas() {
         return document.createElement("canvas")
      }

      function events() {
         window.action.addEvent = function(id, callBack) {
            if(window.action[id] == undefined) {
               window.action[id] = []
            }
            window.action[id].push(callBack)
         }
         window.responseEvent = function(event, type) {
            var id = event.target.id
            if(window.action[id]) {
               window.action[id].forEach(function(item, index){
                  item(event, type)
               })
            }else {
               log("action.id of event are "+window.action[id])
            }
         }
         window.addEventListener("input", function(event) {
            window.responseEvent(event, "input")
         })
         window.addEventListener("change", function(event) {
            window.responseEvent(event, "change")
         })
      }

      //参数为 canvas 和 css选择器
      function setCanvas(canvas, select) {
         var box = e(select)
         canvas.width = box.offsetWidth
         canvas.height = box.offsetHeight
         box.append(canvas)
         return canvas
      }

      //canvas
      function getCanvas(select) {
         return e(select)
      }
      function getContext(canvas) {
         return canvas.getContext("2d")
      }
      function clearCtx(canvas, x, y, w, h) {
         getContext(canvas).clearRect(x, y, w, h)
      }
      function curveOfz(ctx, d1x, d1y, d2x, d2y) {
         var halfGap = (d2x - d1x) / 2
         ctx.moveTo(d1x, d1y)
         ctx.bezierCurveTo(d1x + halfGap, d1y, d2x - halfGap, d2y, d2x, d2y)
      }
      function drawRect(ctx, d1x, d1y, w, h, color) {
         ctx.fillStyle = color
         ctx.fillRect(d1x, d1y, w, h)
      }
      function setFont(canvas, fontSize) {
         var ctx = getContext(canvas)
         ctx.font = fontSize
      }
      function drawText(canvas, text, x, y) {
         var ctx = getContext(canvas)
         ctx.fillText(text, x, y)
      }
   </script>
   <style>
      html,body{
         height: 100%;
         margin: 0;
      }
      #upside-box{
         height: 80%;
      }
      #underside-box{
         height: 20%;
      }
      #underside-box input {
         display: block;
         width: 80%;
         height: 80%;
         line-height: 60px;
         font-size: 60px;
         margin: auto;
         outline: none;
      }
      canvas{
         display: block;
      }
   </style>
</head>
<body>
   <div id="upside-box">

   </div>
   <div id="underside-box">
      <input id="get" type="text">
   </div>
</body>
</html>
